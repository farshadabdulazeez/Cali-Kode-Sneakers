{% extends 'admin_base.html' %}

{% load static %}

{% block content %}


<div class="container-xxl flex-grow-1 container-p-y">
    <h4 class="fw-bold py-3 mb-4"><span class="text-muted fw-light">ADMIN /</span> DASHBOARD</h4>
   <div class="card">
    <div class="card-header">
        <h5 class="card-title" style="text-align: center; font-weight: bold;">SALES REPORT</h5>
    </div>
    <div class="card-body" style="display: flex; justify-content: space-between;">
        <div style="flex: 1;">
            <h5>ORDER STATUS COUNT</h5>
            <canvas id="orderCountsChart" width="100" height="100"></canvas>
        </div>
        <div style="flex: 1;">
            <h5>PAYMENT METHODS</h5>
            <canvas id="paymentMethodCountsChart" width="100" height="100"></canvas>
        </div>
        <div style="flex: 1;">
            <h5>Total Orders Count</h5>
            <canvas id="totalOrdersChart" width="100" height="100"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var totalProfitCanvas = document.getElementById('orderCountsChart').getContext('2d');
        var orderCountsChart = new Chart(totalProfitCanvas, {
            type: 'pie',
            data: {
                labels: ['Delivered', 'Returned', 'Cancelled'],
                datasets: [{
                    data: [{{ successfull_orders_count }},
                    {{ returned_orders_count }},
                    {{ cancelled_orders_count }},],
                    backgroundColor: ['green', 'blue', 'red']
                }]
            }
        });

        var totalRevenueCanvas = document.getElementById('paymentMethodCountsChart').getContext('2d');
        var paymentMethodCountsChart = new Chart(totalRevenueCanvas, {
            type: 'pie',
            data: {
                labels: ['Cash on Delivery', 'Online payment'],
                datasets: [{
                    data: [{{ cash_on_delivery_count }},
                    {{ razorpay_count }},],
                    backgroundColor: ['orange', 'purple']
                }]
            }
        });

        var totalOrdersCanvas = document.getElementById('totalOrdersChart').getContext('2d');
        var totalOrdersChart = new Chart(totalOrdersCanvas, {
            type: 'pie',
            data: {
                labels: ['Orders', 'Other'],
                datasets: [{
                    data: [{{ order_count }}, 100 - {{ order_count }}],
                    backgroundColor: ['blue', 'yellow']
                }]
            }
        });
    </script>
    
    <div class="card" style="margin-top: 20px;">
      <div class="card-header">
          <h5 class="card-title" style="text-align: center; font-weight: bold;">SALES ORDER DATA REPORT</h5>
      </div>
      <div class="card-body" style="text-align: center;">
          <div style="display: flex; justify-content: center;">
              <canvas id="myChart" style="width:80%;max-width:600px"></canvas>
          </div>
          <div style="margin-top: 20px; display: flex; justify-content: center;">
              <input type="checkbox" id="daily" name="salesType" value="day" style="margin-right: 10px;">
              <label for="daily" style="cursor: pointer; font-weight: bold; margin-right: 5px;">Daily</label>
  
              <input type="checkbox" id="monthly" name="salesType" value="month" style="margin-right: 10px;">
              <label for="monthly" style="cursor: pointer; font-weight: bold; margin-right: 5px;">Monthly</label>
  
              <input type="checkbox" id="yearly" name="salesType" value="year" style="margin-right: 10px;">
              <label for="yearly" style="cursor: pointer; font-weight: bold; margin-right: 5px;">Yearly</label>
          </div>
      </div>
  </div>
  
  <script>
      // Retrieve the initial monthly sales data
      var salesData = JSON.parse('{{ monthly_sales_data|escapejs|safe }}');
  
      // Default monthly sales chart
      renderChart('month');
  
      // Add event listeners for the checkbox changes
      document.querySelectorAll('input[type=checkbox][name=salesType]').forEach((checkbox) => {
          checkbox.addEventListener('click', (event) => {
              if (event.target.checked) {
                  document.querySelectorAll('input[type=checkbox][name=salesType]').forEach((input) => {
                      if (input !== event.target) {
                          input.checked = false;
                      }
                  });
                  renderChart(event.target.value);
              }
          });
      });
  
      // Function to update the chart based on the selected option
      function renderChart(option) {
          var chartData;
          if (option === 'day') {
              chartData = JSON.parse('{{ daily_sales_data|escapejs|safe }}');
          } else if (option === 'month') {
              chartData = JSON.parse('{{ monthly_sales_data|escapejs|safe }}');
          } else if (option === 'year') {
              chartData = JSON.parse('{{ yearly_sales_data|escapejs|safe }}');
          }
  
          var ctx = document.getElementById('myChart').getContext('2d');
          new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: chartData.xValues,
                  datasets: [{
                      label: 'Sales Report',
                      data: chartData.yValues,
                      backgroundColor: chartData.barColors
                  }]
              },
              options: {
                  maintainAspectRatio: false,
                  aspectRatio: 2,
                  scales: {
                      y: {
                          beginAtZero: true
                      },
                      x: {
                          type: 'category',
                          labels: chartData.xValues
                      }
                  },
                  legend: { display: false },
                  title: {
                      display: true,
                      text: "Sales Report"
                  }
              }
          });
      }
  </script>
  
  
  <div class="search" style="display: flex; align-items: center; margin-top: 20px; margin-right: 20px; ">
    <form method="GET" style="display: flex; align-items: center;">
        <label for="start_date" style="margin-right: 10px;">From:</label>
        <input type="date" id="start_date" name="start_date" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px;">
        <label for="end_date" style="margin-right: 10px;">To:</label>
        <input type="date" id="end_date" name="end_date" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px;">
        <button type="submit" style="padding: 8px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Filter by Date</button>
    </form>
    <form method="GET" style="display: flex; align-items: center; margin-left: auto;">
        <input type="text" name="q" placeholder="Search..." style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px;">
        <button type="submit" style="padding: 8px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
    </form>
    
</div>

  <table id="myTable" class="table table-striped" style="width:100%">
      <thead>
          <tr>
              <th>ORDER ID</th>
              <th>CUSTOMER</th>
              <th>ORDER DATE</th>
              <th>TOTAL</th>
              <th>ORDER STATUS</th>
              <td rowspan="{{ orders|length }}">
                  <a href="{% url 'admin_sales_report' %}?pdf" class="btn btn-primary">Download as PDF</a>
              </td>
          </tr>
      </thead>
      <tbody>
          {% for order in orders %}
          <tr>
              <td>{{order.order_id}}</td>
              <td>{{order.address.name}}</td>
              <td>{{order.created}}</td>
              <td>{{order.order_total}}</td>
              <td>{{order.status}}</td>
              <td><a href="{% url 'admin_order_details' order.order_id %}" class="check-btn sqr-btn">View</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <div class="pagination" style="display: flex; justify-content: flex-end; align-items: center; margin-top: 30px;  margin-right: 20px;">
    <span class="step-links">
        {% if orders.has_previous %}
            <a href="?page=1" style="padding: 4px 8px; text-decoration: none; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px;">&laquo; first</a>
            <a href="?page={{ orders.previous_page_number }}" style="padding: 4px 8px; text-decoration: none; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px;">previous</a>
        {% endif %}

        <span class="current" style="margin: 0 10px;">
            Page {{ orders.number }} of {{ orders.paginator.num_pages }}.
        </span>

        {% if orders.has_next %}
            <a href="?page={{ orders.next_page_number }}" style="padding: 4px 8px; text-decoration: none; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px;">next</a>
        {% endif %}

        {% if orders.has_next %}
            <a href="?page={{ orders.paginator.num_pages }}" style="padding: 4px 8px; text-decoration: none; border: 1px solid #ccc; border-radius: 4px;">last &raquo;</a>
        {% endif %}
    </span>
    </div>



</div>

{% endblock content %}
